# ============================================================================
# Docker Build and Push Workflow
# ============================================================================
#
# This workflow handles Docker image building, testing, and pushing to registries.
# Supports both development and production images with multi-platform builds.
#
# FEATURES:
# - Multi-platform builds (AMD64, ARM64)
# - Development and production image variants
# - Container security scanning
# - Registry push (Docker Hub, ECR, GHCR)
# - Image optimization and caching
# - Vulnerability scanning
#
# TRIGGERS:
# - Push to main branch (build and push)
# - Pull requests (build and test only)
# - Manual dispatch with registry options
# - Release tags (production builds)
#
# ============================================================================

name: Docker Build & Push

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  
  pull_request:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.dockerignore'
      - 'nginx.conf'
  
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push images to registry'
        required: false
        default: false
        type: boolean
      registry:
        description: 'Target registry'
        required: false
        default: 'ghcr'
        type: choice
        options:
          - ghcr
          - dockerhub
          - ecr
      platforms:
        description: 'Target platforms'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io
  IMAGE_NAME: phaserai
  
jobs:
  # ============================================================================
  # JOB 1: BUILD AND TEST DOCKER IMAGES
  # ============================================================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
      should-push: ${{ steps.push-decision.outputs.should-push }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      
      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
            ${{ env.REGISTRY_DOCKERHUB }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=dev,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=PhaserAI
            org.opencontainers.image.description=Conlang creation and management application
            org.opencontainers.image.vendor=PhaserAI
      
      - name: Determine Push Strategy
        id: push-decision
        run: |
          echo "üöÄ Determining push strategy..."
          
          SHOULD_PUSH=false
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.push_to_registry }}" = "true" ]; then
            echo "Manual dispatch with push enabled"
            SHOULD_PUSH=true
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Push to main branch - will push to registry"
            SHOULD_PUSH=true
          elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "Release tag - will push to registry"
            SHOULD_PUSH=true
          else
            echo "PR or other event - build only, no push"
            SHOULD_PUSH=false
          fi
          
          echo "should-push=$SHOULD_PUSH" >> $GITHUB_OUTPUT
          echo "Will push to registry: $SHOULD_PUSH"
      
      # ========================================================================
      # DEVELOPMENT IMAGE BUILD
      # ========================================================================
      - name: Build Development Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.dev
          platforms: ${{ github.event.inputs.platforms || 'linux/amd64' }}
          push: false
          tags: ${{ env.IMAGE_NAME }}-dev:test
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=dummy_dev_url
            VITE_SUPABASE_ANON_KEY=dummy_dev_key
          cache-from: type=gha,scope=dev
          cache-to: type=gha,mode=max,scope=dev
      
      # ========================================================================
      # PRODUCTION IMAGE BUILD
      # ========================================================================
      - name: Build Production Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ github.event.inputs.platforms || 'linux/amd64' }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=dummy_prod_url
            VITE_SUPABASE_ANON_KEY=dummy_prod_key
          cache-from: type=gha,scope=prod
          cache-to: type=gha,mode=max,scope=prod
          outputs: type=docker,dest=/tmp/phaserai-image.tar
      
      # ========================================================================
      # IMAGE TESTING
      # ========================================================================
      - name: Load and Test Images
        run: |
          echo "üß™ Loading and testing Docker images..."
          
          # Load production image
          docker load --input /tmp/phaserai-image.tar
          
          # Get the first tag for testing
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "Testing image: $IMAGE_TAG"
          
          # Test image structure
          echo "üìã Image inspection:"
          docker inspect "$IMAGE_TAG" --format='{{.Config.ExposedPorts}}'
          docker inspect "$IMAGE_TAG" --format='{{.Config.Env}}'
          
          # Test container startup
          echo "üöÄ Testing container startup..."
          CONTAINER_ID=$(docker run -d -p 8080:80 "$IMAGE_TAG")
          
          # Wait for container to be ready
          sleep 10
          
          # Health check
          echo "üè• Running health checks..."
          if curl -f http://localhost:8080 > /dev/null 2>&1; then
            echo "‚úÖ Container health check passed"
          else
            echo "‚ö†Ô∏è Container health check failed"
            docker logs "$CONTAINER_ID"
          fi
          
          # Cleanup
          docker stop "$CONTAINER_ID"
          docker rm "$CONTAINER_ID"
          
          echo "‚úÖ Image testing completed"
      
      # ========================================================================
      # SECURITY SCANNING
      # ========================================================================
      - name: Run Container Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/phaserai-image.tar
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Security Scan Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      # ========================================================================
      # ARTIFACT UPLOAD
      # ========================================================================
      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/phaserai-image.tar
          retention-days: 7

  # ============================================================================
  # JOB 2: PUSH TO REGISTRIES
  # ============================================================================
  docker-push:
    name: Push to Registry
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: docker-build
    if: needs.docker-build.outputs.should-push == 'true'
    
    strategy:
      matrix:
        registry: [ghcr]  # Add more registries as needed: [ghcr, dockerhub, ecr]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        if: matrix.registry == 'ghcr'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Log in to Docker Hub
        if: matrix.registry == 'dockerhub'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKERHUB }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Configure AWS Credentials for ECR
        if: matrix.registry == 'ecr'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Log in to Amazon ECR
        if: matrix.registry == 'ecr'
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Extract Metadata for Registry
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ matrix.registry == 'ghcr' && format('{0}/{1}/{2}', env.REGISTRY_GHCR, github.repository, env.IMAGE_NAME) || '' }}
            ${{ matrix.registry == 'dockerhub' && format('{0}/{1}/{2}', env.REGISTRY_DOCKERHUB, github.repository_owner, env.IMAGE_NAME) || '' }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and Push to Registry
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL || 'dummy_url' }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY || 'dummy_key' }}
          cache-from: type=gha,scope=prod
          cache-to: type=gha,mode=max,scope=prod
      
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.meta.outputs.tags }}
          format: spdx-json
          output-file: sbom.spdx.json
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.registry }}
          path: sbom.spdx.json
          retention-days: 30

  # ============================================================================
  # JOB 3: IMAGE VERIFICATION
  # ============================================================================
  verify-images:
    name: Verify Pushed Images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [docker-build, docker-push]
    if: needs.docker-build.outputs.should-push == 'true'
    
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Image Signatures
        run: |
          echo "üîê Verifying pushed images..."
          
          # Get image tags from previous job
          TAGS="${{ needs.docker-build.outputs.image-tags }}"
          
          for tag in $TAGS; do
            if [[ $tag == *"ghcr.io"* ]]; then
              echo "Verifying: $tag"
              
              # Pull and inspect image
              docker pull "$tag"
              docker inspect "$tag" --format='{{.RepoDigests}}'
              
              # Basic functionality test
              CONTAINER_ID=$(docker run -d -p 8081:80 "$tag")
              sleep 5
              
              if curl -f http://localhost:8081 > /dev/null 2>&1; then
                echo "‚úÖ Image $tag verification passed"
              else
                echo "‚ùå Image $tag verification failed"
              fi
              
              docker stop "$CONTAINER_ID"
              docker rm "$CONTAINER_ID"
            fi
          done

  # ============================================================================
  # JOB 4: CLEANUP AND NOTIFICATION
  # ============================================================================
  docker-summary:
    name: Docker Build Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [docker-build, docker-push, verify-images]
    if: always()
    
    steps:
      - name: Docker Pipeline Summary
        run: |
          echo "üê≥ Docker Pipeline Summary"
          echo "=========================="
          echo "Build: ${{ needs.docker-build.result }}"
          echo "Push: ${{ needs.docker-push.result }}"
          echo "Verify: ${{ needs.verify-images.result }}"
          echo "Should Push: ${{ needs.docker-build.outputs.should-push }}"
          
          if [ "${{ needs.docker-build.result }}" = "success" ]; then
            echo "‚úÖ Docker images built successfully"
            
            if [ "${{ needs.docker-build.outputs.should-push }}" = "true" ]; then
              if [ "${{ needs.docker-push.result }}" = "success" ]; then
                echo "‚úÖ Images pushed to registry successfully"
              else
                echo "‚ùå Image push failed"
              fi
            else
              echo "‚ÑπÔ∏è Images built but not pushed (PR or test build)"
            fi
          else
            echo "‚ùå Docker build failed"
          fi
          
          echo ""
          echo "Image Tags: ${{ needs.docker-build.outputs.image-tags }}"
          echo "Image Digest: ${{ needs.docker-build.outputs.image-digest }}"