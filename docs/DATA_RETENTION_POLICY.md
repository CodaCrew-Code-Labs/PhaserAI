# PhaserAI Data Retention Policy

This document defines the data retention policies for PhaserAI, covering user data, system logs, backups, and compliance requirements.

## üìã Table of Contents

- [Overview](#overview)
- [Data Classification](#data-classification)
- [Retention Schedules](#retention-schedules)
- [Backup Retention](#backup-retention)
- [Log Retention](#log-retention)
- [User Data Rights](#user-data-rights)
- [Compliance Requirements](#compliance-requirements)
- [Implementation](#implementation)
- [Monitoring and Auditing](#monitoring-and-auditing)

## üéØ Overview

### Purpose
This policy establishes consistent data retention practices to:
- Comply with legal and regulatory requirements
- Optimize storage costs and performance
- Protect user privacy and data rights
- Support business operations and analytics
- Enable disaster recovery capabilities

### Scope
This policy applies to all data stored, processed, or transmitted by PhaserAI, including:
- User account information
- Language and lexicon data
- Application logs and metrics
- Database backups
- System configuration data
- Audit trails and security logs

### Principles
- **Legal Compliance**: Meet all applicable legal requirements
- **Data Minimization**: Retain only necessary data
- **User Rights**: Respect user privacy and deletion requests
- **Security**: Protect data throughout its lifecycle
- **Cost Optimization**: Balance retention needs with storage costs

## üìä Data Classification

### Personal Data (PII)
**Definition**: Information that can identify a specific user
**Examples**: Email addresses, usernames, IP addresses, authentication tokens

**Retention Requirements**:
- Active users: Retained while account is active
- Inactive users: 3 years after last login
- Deleted accounts: 30 days (for recovery), then permanently deleted
- Legal hold: Indefinite (until hold is lifted)

### User-Generated Content
**Definition**: Data created by users within the application
**Examples**: Languages, words, translations, etymology data

**Retention Requirements**:
- Active accounts: Retained while account is active
- Deleted accounts: 30 days (for recovery), then permanently deleted
- Exported data: User responsibility after export
- Shared/public data: May be retained for community benefit (anonymized)

### System Data
**Definition**: Technical data generated by system operations
**Examples**: Performance metrics, error logs, audit trails

**Retention Requirements**:
- Application logs: 90 days (production), 30 days (staging/dev)
- Security logs: 1 year (production), 90 days (staging/dev)
- Audit trails: 7 years (compliance requirement)
- Performance metrics: 1 year (detailed), 3 years (aggregated)

### Backup Data
**Definition**: Copies of data for disaster recovery purposes
**Examples**: Database backups, file system backups

**Retention Requirements**:
- Daily backups: 35 days (production), 7 days (staging/dev)
- Weekly backups: 1 year (production only)
- Monthly backups: 7 years (production only)
- Point-in-time recovery: 7 days (production), 1 day (staging/dev)

## üìÖ Retention Schedules

### Production Environment

#### User Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| Active user accounts | While active + 3 years after last login | Automated soft delete, then hard delete | GDPR compliance |
| Deleted user accounts | 30 days | Hard delete with secure wipe | Recovery period |
| User preferences | Same as user account | Cascading delete | Linked to user account |
| Authentication logs | 1 year | Automated deletion | Security requirement |

#### Application Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| Languages | While user account active + 30 days | Cascading delete | User-generated content |
| Words and translations | While user account active + 30 days | Cascading delete | User-generated content |
| Etymology data | While user account active + 30 days | Cascading delete | User-generated content |
| Violation logs | 90 days | Automated deletion | System-generated |

#### System Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| Application logs | 90 days | CloudWatch automatic deletion | Operational data |
| Error logs | 90 days | CloudWatch automatic deletion | Debugging data |
| Security logs | 1 year | CloudWatch automatic deletion | Security monitoring |
| Audit trails | 7 years | Archived to Glacier | Compliance requirement |
| Performance metrics | 1 year detailed, 3 years aggregated | CloudWatch automatic deletion | Monitoring data |

#### Backup Data
| Data Type | Retention Period | Storage Class | Notes |
|-----------|------------------|---------------|-------|
| Daily backups | 35 days | Standard ‚Üí IA (30 days) | Operational recovery |
| Weekly backups | 1 year | IA ‚Üí Glacier (30 days) | Extended recovery |
| Monthly backups | 7 years | Glacier ‚Üí Deep Archive (90 days) | Long-term compliance |
| Migration backups | 90 days | Standard | Pre-deployment safety |

### Staging Environment

#### User Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| Test user accounts | 30 days after creation | Automated deletion | Testing data |
| Test data | 7 days | Automated deletion | Development testing |

#### System Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| Application logs | 30 days | CloudWatch automatic deletion | Testing logs |
| Performance metrics | 30 days | CloudWatch automatic deletion | Testing metrics |

#### Backup Data
| Data Type | Retention Period | Storage Class | Notes |
|-----------|------------------|---------------|-------|
| Daily backups | 7 days | Standard | Testing recovery |

### Development Environment

#### All Data
| Data Type | Retention Period | Deletion Method | Notes |
|-----------|------------------|-----------------|-------|
| All development data | 7 days | Automated deletion | Development only |
| Developer logs | 7 days | Local cleanup | Development debugging |

## üíæ Backup Retention

### Automated Backup Lifecycle

#### Production Backups
```yaml
Daily Backups:
  Retention: 35 days
  Storage Transitions:
    - Day 0: Standard storage
    - Day 30: Infrequent Access
    - Day 35: Deleted

Weekly Backups:
  Retention: 1 year
  Storage Transitions:
    - Day 0: Standard storage
    - Day 30: Infrequent Access
    - Day 90: Glacier
    - Day 365: Deleted

Monthly Backups:
  Retention: 7 years
  Storage Transitions:
    - Day 0: Standard storage
    - Day 30: Infrequent Access
    - Day 90: Glacier
    - Day 365: Deep Archive
    - Day 2555: Deleted
```

#### Cross-Region Replication
```yaml
Primary Region: us-east-1
Secondary Region: us-west-2
Replication:
  - Daily backups: 7 days
  - Weekly backups: 90 days
  - Monthly backups: 1 year
```

### Manual Backup Retention
- **Pre-deployment backups**: 90 days
- **Emergency backups**: 30 days
- **Migration backups**: 90 days
- **Test restoration backups**: 7 days

## üìù Log Retention

### Application Logs

#### CloudWatch Log Groups
```yaml
Production:
  /aws/lambda/phaserai-prod-api: 90 days
  /aws/lambda/phaserai-prod-migration: 30 days
  /aws/apigateway/phaserai-prod: 90 days
  /aws/rds/instance/phaserai-prod/error: 90 days
  /aws/rds/instance/phaserai-prod/general: 30 days
  /aws/rds/instance/phaserai-prod/slowquery: 90 days

Staging:
  /aws/lambda/phaserai-staging-*: 30 days
  /aws/apigateway/phaserai-staging: 30 days
  /aws/rds/instance/phaserai-staging/*: 30 days

Development:
  /aws/lambda/phaserai-dev-*: 7 days
  /aws/apigateway/phaserai-dev: 7 days
  /aws/rds/instance/phaserai-dev/*: 7 days
```

#### Log Archival
```yaml
Long-term Storage:
  Security Logs:
    Retention: 1 year in CloudWatch
    Archive: 7 years in S3 Glacier
    
  Audit Logs:
    Retention: 90 days in CloudWatch
    Archive: 7 years in S3 Glacier
    
  Compliance Logs:
    Retention: 1 year in CloudWatch
    Archive: 7 years in S3 Deep Archive
```

### Access Logs

#### API Gateway Access Logs
- **Production**: 90 days
- **Staging**: 30 days
- **Development**: 7 days

#### Database Access Logs
- **Production**: 1 year
- **Staging**: 30 days
- **Development**: 7 days

#### Authentication Logs
- **Production**: 1 year
- **Staging**: 30 days
- **Development**: 7 days

## üë§ User Data Rights

### Right to Access
Users can request access to their personal data:
- **Response Time**: 30 days
- **Format**: JSON export via API
- **Scope**: All personal data and user-generated content

### Right to Rectification
Users can request correction of inaccurate data:
- **Response Time**: 30 days
- **Method**: User interface or support request
- **Verification**: Identity verification required

### Right to Erasure (Right to be Forgotten)
Users can request deletion of their data:
- **Response Time**: 30 days
- **Scope**: All personal data and user-generated content
- **Exceptions**: Legal obligations, legitimate interests
- **Process**: Soft delete (30 days) ‚Üí Hard delete

### Right to Data Portability
Users can request their data in a portable format:
- **Response Time**: 30 days
- **Format**: JSON, CSV, or XML
- **Scope**: User-generated content and personal data

### Right to Restrict Processing
Users can request restriction of data processing:
- **Response Time**: 30 days
- **Method**: Account suspension or data flagging
- **Duration**: Until restriction is lifted

## ‚öñÔ∏è Compliance Requirements

### GDPR (General Data Protection Regulation)
- **Scope**: EU users and data
- **Retention**: No longer than necessary
- **Deletion**: Right to erasure
- **Documentation**: Data processing records

### CCPA (California Consumer Privacy Act)
- **Scope**: California residents
- **Rights**: Access, deletion, opt-out
- **Response Time**: 45 days
- **Verification**: Identity verification required

### SOX (Sarbanes-Oxley Act)
- **Scope**: Financial and audit data
- **Retention**: 7 years
- **Security**: Access controls and audit trails
- **Documentation**: Compliance reporting

### Industry Standards
- **ISO 27001**: Information security management
- **SOC 2**: Security, availability, processing integrity
- **PCI DSS**: Payment card data (if applicable)

## üîß Implementation

### Automated Retention Policies

#### Database Cleanup Jobs
```sql
-- Daily cleanup job for expired data
CREATE OR REPLACE FUNCTION cleanup_expired_data()
RETURNS void AS $$
BEGIN
    -- Delete soft-deleted users after 30 days
    DELETE FROM app_8b514_users 
    WHERE deleted_at IS NOT NULL 
    AND deleted_at < NOW() - INTERVAL '30 days';
    
    -- Delete old violation logs after 90 days
    DELETE FROM app_8b514_phonological_violations 
    WHERE created_at < NOW() - INTERVAL '90 days';
    
    -- Archive old audit logs
    INSERT INTO audit_logs_archive 
    SELECT * FROM audit_logs 
    WHERE created_at < NOW() - INTERVAL '1 year';
    
    DELETE FROM audit_logs 
    WHERE created_at < NOW() - INTERVAL '1 year';
    
    RAISE NOTICE 'Data cleanup completed at %', NOW();
END;
$$ LANGUAGE plpgsql;

-- Schedule daily execution
SELECT cron.schedule('cleanup-expired-data', '0 2 * * *', 'SELECT cleanup_expired_data();');
```

#### S3 Lifecycle Policies
```json
{
  "Rules": [
    {
      "ID": "BackupLifecycle",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "database-backups/"
      },
      "Transitions": [
        {
          "Days": 30,
          "StorageClass": "STANDARD_IA"
        },
        {
          "Days": 90,
          "StorageClass": "GLACIER"
        },
        {
          "Days": 365,
          "StorageClass": "DEEP_ARCHIVE"
        }
      ],
      "Expiration": {
        "Days": 2555
      }
    },
    {
      "ID": "LogArchiveLifecycle",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "logs/"
      },
      "Transitions": [
        {
          "Days": 90,
          "StorageClass": "GLACIER"
        }
      ],
      "Expiration": {
        "Days": 2555
      }
    }
  ]
}
```

#### CloudWatch Log Retention
```typescript
// CDK configuration for log retention
const logGroups = [
  { name: '/aws/lambda/phaserai-prod-api', retention: logs.RetentionDays.THREE_MONTHS },
  { name: '/aws/lambda/phaserai-prod-migration', retention: logs.RetentionDays.ONE_MONTH },
  { name: '/aws/apigateway/phaserai-prod', retention: logs.RetentionDays.THREE_MONTHS },
];

logGroups.forEach(group => {
  new logs.LogGroup(this, group.name.replace(/[^a-zA-Z0-9]/g, ''), {
    logGroupName: group.name,
    retention: group.retention,
    removalPolicy: cdk.RemovalPolicy.DESTROY,
  });
});
```

### Data Deletion Procedures

#### User Account Deletion
```typescript
async function deleteUserAccount(userId: string): Promise<void> {
  const client = new Client(dbConfig);
  await client.connect();
  
  try {
    await client.query('BEGIN');
    
    // Soft delete user account
    await client.query(
      'UPDATE app_8b514_users SET deleted_at = NOW() WHERE user_id = $1',
      [userId]
    );
    
    // Log deletion for audit
    await client.query(
      'INSERT INTO audit_logs (action, user_id, timestamp, details) VALUES ($1, $2, NOW(), $3)',
      ['USER_DELETION_REQUESTED', userId, 'User account marked for deletion']
    );
    
    await client.query('COMMIT');
    
    // Schedule hard deletion after 30 days
    await scheduleHardDeletion(userId, new Date(Date.now() + 30 * 24 * 60 * 60 * 1000));
    
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    await client.end();
  }
}
```

#### Hard Deletion Process
```typescript
async function hardDeleteUser(userId: string): Promise<void> {
  const client = new Client(dbConfig);
  await client.connect();
  
  try {
    await client.query('BEGIN');
    
    // Delete all user data (cascading deletes handle related data)
    const result = await client.query(
      'DELETE FROM app_8b514_users WHERE user_id = $1 AND deleted_at IS NOT NULL',
      [userId]
    );
    
    if (result.rowCount === 0) {
      throw new Error('User not found or not marked for deletion');
    }
    
    // Log hard deletion
    await client.query(
      'INSERT INTO audit_logs (action, user_id, timestamp, details) VALUES ($1, $2, NOW(), $3)',
      ['USER_HARD_DELETED', userId, 'User account and all data permanently deleted']
    );
    
    await client.query('COMMIT');
    
    // Notify user (if email still available)
    await sendDeletionConfirmation(userId);
    
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    await client.end();
  }
}
```

## üìä Monitoring and Auditing

### Retention Compliance Monitoring

#### Daily Checks
```bash
#!/bin/bash
# Daily retention compliance check

# Check for overdue deletions
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c "
  SELECT 
    'Overdue soft deletions' as check_type,
    COUNT(*) as count
  FROM app_8b514_users 
  WHERE deleted_at IS NOT NULL 
  AND deleted_at < NOW() - INTERVAL '31 days';
"

# Check backup retention
aws backup list-recovery-points-by-backup-vault \
  --backup-vault-name phaserai-prod-vault \
  --query 'RecoveryPoints[?CreationDate<`2024-01-01`]' \
  --output table

# Check log retention
aws logs describe-log-groups \
  --query 'logGroups[?retentionInDays==null]' \
  --output table
```

#### Weekly Reports
```python
#!/usr/bin/env python3
"""
Weekly data retention compliance report
"""

import boto3
import psycopg2
from datetime import datetime, timedelta

def generate_retention_report():
    report = {
        'timestamp': datetime.utcnow().isoformat(),
        'database_compliance': check_database_retention(),
        'backup_compliance': check_backup_retention(),
        'log_compliance': check_log_retention(),
        'user_requests': check_user_requests(),
    }
    
    # Send report to stakeholders
    send_compliance_report(report)
    
    return report

def check_database_retention():
    """Check database data retention compliance"""
    conn = psycopg2.connect(
        host=os.environ['DB_HOST'],
        database=os.environ['DB_NAME'],
        user=os.environ['DB_USER'],
        password=os.environ['DB_PASSWORD']
    )
    
    cur = conn.cursor()
    
    # Check overdue deletions
    cur.execute("""
        SELECT COUNT(*) FROM app_8b514_users 
        WHERE deleted_at IS NOT NULL 
        AND deleted_at < NOW() - INTERVAL '31 days'
    """)
    overdue_deletions = cur.fetchone()[0]
    
    # Check old violation logs
    cur.execute("""
        SELECT COUNT(*) FROM app_8b514_phonological_violations 
        WHERE created_at < NOW() - INTERVAL '91 days'
    """)
    old_violations = cur.fetchone()[0]
    
    conn.close()
    
    return {
        'overdue_user_deletions': overdue_deletions,
        'old_violation_logs': old_violations,
        'compliant': overdue_deletions == 0 and old_violations == 0
    }

def check_backup_retention():
    """Check backup retention compliance"""
    backup_client = boto3.client('backup')
    
    # Check for backups older than retention policy
    old_backups = []
    
    response = backup_client.list_recovery_points_by_backup_vault(
        BackupVaultName='phaserai-prod-vault'
    )
    
    cutoff_date = datetime.utcnow() - timedelta(days=2555)  # 7 years
    
    for backup in response['RecoveryPoints']:
        if backup['CreationDate'].replace(tzinfo=None) < cutoff_date:
            old_backups.append(backup['RecoveryPointArn'])
    
    return {
        'old_backups_count': len(old_backups),
        'old_backup_arns': old_backups,
        'compliant': len(old_backups) == 0
    }

def check_log_retention():
    """Check CloudWatch log retention compliance"""
    logs_client = boto3.client('logs')
    
    response = logs_client.describe_log_groups()
    
    non_compliant_groups = []
    
    for group in response['logGroups']:
        group_name = group['logGroupName']
        retention = group.get('retentionInDays')
        
        # Check if retention is set according to policy
        if '/aws/lambda/phaserai-prod' in group_name and retention != 90:
            non_compliant_groups.append(group_name)
        elif '/aws/lambda/phaserai-staging' in group_name and retention != 30:
            non_compliant_groups.append(group_name)
        elif '/aws/lambda/phaserai-dev' in group_name and retention != 7:
            non_compliant_groups.append(group_name)
    
    return {
        'non_compliant_log_groups': non_compliant_groups,
        'compliant': len(non_compliant_groups) == 0
    }

if __name__ == '__main__':
    report = generate_retention_report()
    print(f"Retention compliance report generated: {report['timestamp']}")
```

### Audit Trail

#### Data Access Logging
```sql
-- Create audit log table
CREATE TABLE IF NOT EXISTS audit_logs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_id TEXT,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id TEXT,
    ip_address INET,
    user_agent TEXT,
    details JSONB,
    retention_date TIMESTAMP WITH TIME ZONE
);

-- Create index for efficient querying
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);

-- Set retention date for audit logs (7 years)
CREATE OR REPLACE FUNCTION set_audit_retention()
RETURNS TRIGGER AS $$
BEGIN
    NEW.retention_date = NEW.timestamp + INTERVAL '7 years';
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_retention_trigger
    BEFORE INSERT ON audit_logs
    FOR EACH ROW EXECUTE FUNCTION set_audit_retention();
```

#### Retention Action Logging
```typescript
async function logRetentionAction(action: string, details: any): Promise<void> {
  const auditLog = {
    timestamp: new Date().toISOString(),
    action: `RETENTION_${action}`,
    resource_type: 'DATA_RETENTION',
    details: {
      ...details,
      policy_version: '1.0',
      automated: true
    }
  };
  
  await client.query(
    'INSERT INTO audit_logs (action, resource_type, details) VALUES ($1, $2, $3)',
    [auditLog.action, auditLog.resource_type, JSON.stringify(auditLog.details)]
  );
}
```

### Compliance Reporting

#### Monthly Compliance Report
- Data retention policy adherence
- User request fulfillment metrics
- Backup verification results
- Security incident impact on retention
- Cost optimization from retention policies

#### Annual Policy Review
- Review retention periods against business needs
- Update policies based on regulatory changes
- Assess cost impact of retention policies
- Validate technical implementation
- Update documentation and procedures

---

**Document Version**: 1.0  
**Last Updated**: 2025-01-01  
**Next Review**: 2025-04-01  
**Owner**: Data Protection Officer  
**Approved By**: Legal Team, Security Team, Engineering Team